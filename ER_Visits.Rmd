---
title: "Modeling ER visits"
output: html_document
editor_options:
  chunk_output_type: console
---

## Emergency room visits

Data received from David Hsu on October 16, 2025 via email
```{r}
ER_visits.dt <- data.table::fread(here::here("data", "Combined_ER_Data.csv"))
ER_visits.df <- ER_visits.dt |>
  as.data.frame()
```

Merge with daily mortality counts
```{r}
library(data.table)

setDT(zip_day)
setDT(ER_visits.df)

# Pad ZipCode to 5 chars; drop non-sensical codes (0/NA/too short/too big)
ER_visits.df[
  , ZipCode := fifelse(ZipCode > 0 & ZipCode < 1e6, sprintf("%05d", ZipCode), NA_character_)
]
ER_visits.df[, Date := as.IDate(Date)]

ER_visits_clean <- ER_visits.df[!is.na(ZipCode) & nchar(ZipCode) == 5]

# Standardize names to match zip_day; optionally collapse duplicates
setnames(ER_visits_clean, c("ZipCode","Date","Total_Visits"),
                           c("zip",    "date","er_visits"))

# If there can be multiple ER rows per (zip,date), aggregate to daily total
ER_visits_clean <- ER_visits_clean[, .(er_visits = sum(er_visits, na.rm = TRUE)),
                                   by = .(zip, date)]

# Standardize zip_day types 
zip_day[, date := as.IDate(date)]
zip_day[, zip  := as.character(zip)] # already looks like "31537", but safe

# Merge: keep all zip_day rows (left join) 
zip_day_with_visits <- merge(
  zip_day,
  ER_visits_clean,
  by = c("zip","date"),
  all.x = TRUE,
  allow.cartesian = TRUE  # only matters if duplicates remain
)

# Optional: treat missing ER as 0 instead of NA
zip_day_with_visits[is.na(er_visits), er_visits := 0L]
```

### Model using logit and Poisson separately

Instead use a two-part “threshold (≤6) + truncated count (>6)” approximation (stays in `fixest`). The process is modeled as:
Part A (logit): probability the true count is ≤6 (we observe 6)
Part B (Poisson on truncated support): conditional mean for counts >6
Then combine for interpretation

```{r}
library(fixest)
library(dplyr)

d2 <- dat %>% mutate(
  is_le6 = as.integer(er_visits == 6L)           # proxy for "true ≤ 6"
)

# Part A: logistic model for being ≤ 6
mA <- feglm(
  is_le6 ~ i(effect, ref="None") | zip + ym + dow,
  data = d2, family = binomial("logit"),
  cluster = ~ zip + ym
)

# Part B: Poisson on Y>6 (treat observed counts >6 as exact)
d_gt6 <- filter(d2, er_visits > 6L)
mB <- fepois(
  er_visits ~ i(effect, ref="None") | zip + ym + dow,
  data = d_gt6, cluster = ~ zip + ym
)

summary(mA); summary(mB)
```

Interpretation of the results from a two-part model for ER visits

Model 1: We fit:
Model 1A (mA): logit model for whether ER visits are in the censored bin (coded as 6)
Model 1B (mB): Poisson model for the number of ER visits given that visits > 6
Both control for ZIP, month (ym), and day-of-week with fixed effects, and cluster SEs by ZIP and month

Model 1A
GLM estimation, family = binomial, Dep. Var.: is_le6
Observations: 1,835,341
Fixed-effects: zip: 673,  ym: 126,  dow: 7
Standard-errors: Clustered (zip & ym) 
                 Estimate Std. Error  z value  Pr(>|z|)    
effect::Threat   0.431304   0.164050  2.62910 0.0085612 ** 
effect::Impact   0.881900   0.380303  2.31894 0.0203983 *  
effect::Cleanup -0.281038   0.243237 -1.15541 0.2479237    
Log-Likelihood: -312,448.7   Adj. Pseudo R2: 0.291291
           BIC:  636,536.5     Squared Cor.: 0.185756
Model 1B
Poisson estimation, Dep. Var.: er_visits
Observations: 2,725,008
Fixed-effects: zip: 928,  ym: 126,  dow: 7
Standard-errors: Clustered (zip & ym) 
                 Estimate Std. Error   z value   Pr(>|z|)    
effect::Threat  -0.080044   0.021385 -3.743002 0.00018183 ***
effect::Impact  -0.241847   0.075104 -3.220179 0.00128111 ** 
effect::Cleanup  0.033312   0.039993  0.832946 0.40487508    
Log-Likelihood: -8,509,566.8   Adj. Pseudo R2: 0.604975
 BIC: 17,034,870.3     Squared Cor.: 0.880402
 
Model 1A: Probability that ER visits are in the “≤6” bin
Outcome:
is_le6 = 1 if er_visits == 6 (i.e., the left-censored bin “true ≤ 6"),
is_le6 = 0 if er_visits > 6

Key coefficients (log-odds; exponentiated below as odds ratios):
Threat: 0.4313 → OR ≈ 1.54
Impact: 0.8819 → OR ≈ 2.42
Cleanup: −0.2810 → OR ≈ 0.75 (not statistically significant)

Interpretation (all relative to None days, holding ZIP, ym, and DOW constant):
On Threat days, the odds that the ER count is in the censored bucket (≤6) are about 54% higher than on None days
On Impact days, the odds of being in the censored bucket are about 2.4 times higher than on None days
On Cleanup days, the odds are about 25% lower, but this is not statistically significant (p ≈ 0.25), so we can’t confidently claim a difference from None

In other words, Threat and Impact days are more likely to be “low-visit” days (in the censored sense) compared with normal (None) days, after accounting for location, season, and weekday

Model 1B: Mean ER visits given > 6 visits
Outcome:
er_visits (count) but only on days where er_visits > 6. This is a Poisson FE model.
Exponentiating the coefficients gives rate ratios (RRs):
Threat: −0.0800 → RR ≈ 0.92
Impact: −0.2418 → RR ≈ 0.79
Cleanup: 0.0333 → RR ≈ 1.03 (not significant)

Interpretation (again relative to None days, conditional on being > 6):
On Threat days, among days with >6 visits, the mean ER count is about 7–8% lower than on None days (RR ≈ 0.92, p < 0.001)
On Impact days, given >6 visits, the mean count is about 21–22% lower than on None days (RR ≈ 0.79, p ≈ 0.001)
On Cleanup days, the mean is about 3% higher, but not statistically distinguishable from None (p ≈ 0.40)
So, when the ER is “busy” ( > 6 visits), Threat and Impact days actually show fewer visits than comparable None days, controlling for ZIP, month, and DOW

Putting both parts together
Think of the ER visits distribution on a given day in two stages:
Stage 1 – Are visits in the low bin (≤6) or above it?
Threat and Impact days are more likely than None days to fall in the low (≤6) category.
Cleanup days don’t differ clearly from None.
Stage 2 – If visits are above 6, how large is the count?
On Threat and Impact days with >6 visits, the average ER volume is lower than on comparable None days.
Cleanup days again look similar to None

Qualitatively:
Threat & Impact:
Higher chance of being in the censored/low bucket.
Lower mean when above the threshold.

Overall, these phases shift the ER visit distribution downward relative to None days, given the censoring structure.
Cleanup:
No strong evidence of a difference from None in either the probability of being ≤6 or the mean above 6.
This is all conditional on our controls (ZIP FE, ym FE, DOW FE), so those patterns are net of geography, broad seasonality/trend, and weekday effects

We can
Convert these effects into an approximate overall change in mean ER visits by effect (combining both stages), or
Compare these ER patterns to the death models to see how ER demand vs. mortality co-move across storm effect phases