---
title: "Figures"
output: html_document
editor_options:
  chunk_output_type: console
---

## Figure 1
```{r}
library(sf)
library(dplyr)

storm_intensity <- 64
begin_year <- 1985 # 1985 for 55+ winds, 1981 for 34+ winds
end_year <- 2022
begin_date <- paste0(begin_year, "-01-01")
end_date <- paste0(end_year, "-12-31")

L <- "https://www.ncei.noaa.gov/data/international-best-track-archive-for-climate-stewardship-ibtracs/v04r00/access/shapefile/IBTrACS.NA.list.v04r00.lines.zip"
  
if(!"IBTrACS.NA.list.v04r00.lines.zip" %in% list.files(here::here("data"))) {
download.file(url = L,
              destfile = here::here("data",
                                    "IBTrACS.NA.list.v04r00.lines.zip"))
unzip(here::here("data", "IBTrACS.NA.list.v04r00.lines.zip"),
      exdir = here::here("data"))
}

Tracks.sf <- st_read(dsn = here::here("data"), 
                     layer = "IBTrACS.NA.list.v04r00.lines") |>
  st_transform(crs = 32616)

Tracks.sf <- Tracks.sf |>
  filter(year >= begin_year & year <= end_year) |>
  filter(USA_WIND >= storm_intensity) |>
  select(SID, SEASON, year, month, day, hour, min,
         NAME, SUBBASIN, ISO_TIME, USA_WIND, USA_PRES, USA_RMW, USA_EYE, USA_ROCI)

Tracks.sf |>
  st_drop_geometry() |>
  summarize(avgRMW = mean(USA_RMW, na.rm = TRUE) * 1.852,
                   avgEYE = mean(USA_EYE, na.rm = TRUE) * 1.852,
                   avgROCI = mean(USA_ROCI, na.rm = TRUE) * 1.852)

Tracks.sf <- Tracks.sf |>
  group_by(SID) |>
  mutate(USA_RMW = ifelse(is.na(USA_RMW), mean(USA_RMW, na.rm = TRUE), USA_RMW))

Tracks.sf <- Tracks.sf |>
  group_by(USA_PRES) |>
  mutate(USA_RMW = ifelse(is.na(USA_RMW), mean(USA_RMW, na.rm = TRUE), USA_RMW))

Tracks.sf <- Tracks.sf |>
  group_by(SID) |>
  mutate(USA_RMW = ifelse(is.na(USA_RMW), mean(USA_RMW, na.rm = TRUE), USA_RMW))

Swaths.sf <- Tracks.sf |>
  st_buffer(dist = Tracks.sf$USA_RMW * 1852) # 1852 converts to meters

Boundaries.sf <- USAboundaries::us_states(resolution = "low", states = "FL") |> 
  st_transform(crs = 32616)

X <- Swaths.sf |>
  st_intersects(Boundaries.sf, sparse = FALSE) #Does the swath intersect the state border?
Swaths.sf <- Swaths.sf[X, ]
Swaths.sf <- Swaths.sf |>
  mutate(Date = lubridate::as_date(ISO_TIME)) #Add a date column

Swaths.sf <- Swaths.sf |>
  group_by(SID) |>
  summarize(Date0 = first(Date),
            NAME = first(NAME),
            Wind = max(USA_WIND),
            geometry = st_union(geometry)) |>
  mutate(Storm_Category = case_when(
    Wind >= 34 & Wind <= 63 ~ 0,
    Wind >= 64 & Wind <= 82 ~ 1,
    Wind >= 83 & Wind <= 95 ~ 2,
    Wind >= 96 & Wind <= 112 ~ 3,
    Wind >= 113 & Wind <= 136 ~ 4,
    Wind >= 137 ~ 5
  ))

sf_use_s2(TRUE)

Swaths.sf <- Swaths.sf |>
    st_transform(crs = 4326)
union_Swaths2.sfg <- Swaths.sf |>
  st_union()

library(tidyr)
library(lubridate)

min_lag  <- -8  
max_lead <- 8

TIC.sf <- Swaths.sf %>%
  rowwise() %>%
  mutate(event_days = list(
    tibble(
      Date     = Date0 + (min_lag:max_lead),
      rel_day  = min_lag:max_lead
    )
  )) %>%
  unnest(event_days) %>%
  ungroup() %>%
  select(
    Date,
    rel_day,
    Storm_Name = NAME,
    Storm_Category
  )

TIC.sf <- TIC.sf %>%
  mutate(
    rel_day_f = factor(rel_day)
  )

TIC.sf <- TIC.sf |>
  mutate(Month = lubridate::month(Date),
         Year = lubridate::year(Date))
storm_months <- unique(TIC.sf$Month)
storm_year_range <- range(TIC.sf$Year)

st_geometry(TIC.sf) <- "geom"

library(data.table)
library(tigris)
library(sf)
library(dplyr)

options(tigris_use_cache = TRUE)

zcta_us <- zctas(cb = TRUE, year = 2020) %>%
  select(zip = ZCTA5CE20, geometry)

fl <- states(cb = TRUE, year = 2020) %>%
  filter(STUSPS == "FL") %>%
  st_transform(st_crs(zcta_us))

zctas_fl <- st_join(zcta_us, fl, join = st_intersects, left = FALSE) %>%
  select(zip, geometry)

tic_aligned <- st_transform(TIC.sf, st_crs(zctas_fl))

tic_keep <- tic_aligned %>%
  select(Date, rel_day, geom)

zcta_date_rel_sf <- st_join(
  zctas_fl,
  tic_keep,
  join = st_intersects,
  left = FALSE
)

zcta_date_rel <- as.data.table(st_drop_geometry(zcta_date_rel_sf))
setnames(zcta_date_rel, c("zip", "Date", "rel_day"), c("zip", "date", "rel_day"))

zcta_date_rel[, `:=`(
  zip     = as.character(zip),
  date    = as.IDate(date),
  rel_day = as.integer(rel_day)
)]

zcta_date_rel <- zcta_date_rel[
  , .SD[order(abs(rel_day), rel_day)][1],
  by = .(zip, date)
]

all_zips <- sort(unique(zctas_fl$zip))
all_dates <- as.IDate(seq(as.Date(begin_date), as.Date(end_date), by = "day"))
grid <- CJ(zip = as.character(all_zips), date = all_dates)

rel_calendar <- zcta_date_rel[grid, on = .(zip, date)]

min_lag  <-  -8L
max_lead <-  8L

rel_levels <- c("None", as.character(min_lag:max_lead))

rel_calendar[, rel_day_f := fifelse(is.na(rel_day), "None", as.character(rel_day))]
rel_calendar[, rel_day_f := factor(rel_day_f, levels = rel_levels)]

stopifnot(rel_calendar[, .N, by = .(zip, date)][, all(N == 1)])
rel_calendar[, table(rel_day_f)]

library(sf)
library(dplyr)
library(ggplot2)
library(data.table)
library(lubridate)
library(patchwork)
library(RColorBrewer)
library(grid)

# ---- Parameters ----
min_lag  <- -8L
max_lead <-  8L
pad_km   <- 100 

if (!exists("zctas_fl")) {
  library(tigris)
  options(tigris_use_cache = TRUE)
  zcta_us <- zctas(cb = TRUE, year = 2020) %>% select(zip = ZCTA5CE20, geometry)
  fl      <- states(cb = TRUE, year = 2020) %>% filter(STUSPS == "FL") %>%
             st_transform(st_crs(zcta_us))
  zctas_fl <- st_join(zcta_us, fl, join = st_intersects, left = FALSE) %>%
              select(zip, geometry)
}

# ---- 1) Select Hurricane Michael (2018) ----
example_storm <- Swaths.sf %>%
  filter(lubridate::year(Date0) == 2018,
         toupper(NAME) == "MICHAEL") %>%
  slice(1)
stopifnot(nrow(example_storm) == 1L)

example_sid   <- example_storm$SID
example_name  <- example_storm$NAME
example_date0 <- example_storm$Date0

# ---- 2) Prepare geometries in a projected CRS (meters) ----
crs_m     <- 32616  # UTM Zone 16N
fl_utm    <- st_transform(Boundaries.sf, crs_m)
tracks_ex <- Tracks.sf %>% filter(SID == example_sid) %>% st_transform(crs_m)
swath_ex  <- example_storm %>% st_transform(crs_m)

# Build bounding box padded by ~100 km for Panel A
bb   <- st_bbox(fl_utm)
pad  <- pad_km * 1000
xlim <- c(bb["xmin"] - pad, bb["xmax"] + pad)
ylim <- c(bb["ymin"] - pad, bb["ymax"] + pad)

# ---- Arrow at the northern-most track point (Panel A) ----
coords   <- st_coordinates(tracks_ex)  # columns: X, Y, (and L1/L2 if multilines)
idx_maxY <- which.max(coords[, "Y"])
idx_prev <- if (idx_maxY > 1) idx_maxY - 1L else idx_maxY + 1L
v        <- c(coords[idx_maxY, "X"] - coords[idx_prev, "X"],
              coords[idx_maxY, "Y"] - coords[idx_prev, "Y"])
v_norm   <- v / sqrt(sum(v^2))
arrow_len <- 80000  # 80 km
arrow_df <- data.frame(
  x    = coords[idx_maxY, "X"],
  y    = coords[idx_maxY, "Y"],
  xend = coords[idx_maxY, "X"] + arrow_len * v_norm[1],
  yend = coords[idx_maxY, "Y"] + arrow_len * v_norm[2]
)

# ======================
# Panel A: Main map
# ======================
pA <- ggplot() +
  geom_sf(data = fl_utm,  fill = "grey98", color = "grey40", linewidth = 0.25) +
  geom_sf(data = swath_ex, fill = "#F8766D", color = NA, alpha = 0.30) +
  geom_sf(data = tracks_ex, color = "#2C3E50", linewidth = 0.8) +
  # Start/end markers (optional)
  geom_sf(data = tracks_ex %>% slice(1),   color = "#2C3E50", size = 2) +
  geom_sf(data = tracks_ex %>% slice(n()), color = "#2C3E50", size = 2, shape = 17) +
  # Arrow showing continued motion away from Florida at northern-most point
  geom_segment(data = arrow_df,
               aes(x = x, y = y, xend = xend, yend = yend),
               inherit.aes = FALSE,
               color = "#2C3E50", linewidth = 0.8,
               arrow = arrow(length = unit(3, "mm"), type = "closed")) +
  coord_sf(xlim = xlim, ylim = ylim, expand = FALSE) +
  labs(
    title    = "A. Hurricane Michael (2018)",
#    subtitle = paste0("Impact date: ", example_date0),
    x = NULL, y = NULL
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold"),
    panel.grid = element_blank(),
    axis.text  = element_text(size = 6)
  )

# ======================
# Panel B: Inset as a full panel to the right (ZIP outlines that intersect swath)
# ======================

# Compute intersecting ZIPs (in UTM)
zctas_fl_m <- st_transform(zctas_fl, crs_m)
swath_ex_m <- st_transform(swath_ex,  crs_m)

zip_michael <- st_intersection(zctas_fl_m, swath_ex_m) %>%
  st_drop_geometry() %>% pull(zip) %>% unique()

zips_touch <- zctas_fl_m %>% filter(zip %in% zip_michael)

# Tight bbox around the intersecting ZIPs with ~20 km padding
bbox_zip   <- sf::st_bbox(sf::st_union(zips_touch))
pad_inset  <- 20000  # meters
xlim_inset <- c(bbox_zip["xmin"] - pad_inset, bbox_zip["xmax"] + pad_inset)
ylim_inset <- c(bbox_zip["ymin"] - pad_inset, bbox_zip["ymax"] + pad_inset)

pB <- ggplot() +
  geom_sf(data = zips_touch, fill = NA, color = "#5B4EBC", linewidth = 0.5) +
  geom_sf(data = swath_ex_m, fill = "#F8766D", color = NA, alpha = 0.35) +
  coord_sf(xlim = xlim_inset, ylim = ylim_inset, expand = FALSE) +
  labs(
    title = "B. ZIP exposures",
#    subtitle = "Outlines only; swath overlaid",
    x = NULL, y = NULL
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold"),
    panel.grid = element_blank(),
    axis.text  = element_text(size = 6)
  )

# ======================
# Panel C: ZIP × day calendar (Michael-only), full width below
# ======================

# Build ZIP × date grid for ±8 days around Date0 (only intersecting ZIPs)
win_dates <- seq(as.Date(example_date0) + min_lag,
                 as.Date(example_date0) + max_lead, by = "1 day")

cal_michael <- as.data.table(expand.grid(
  zip  = zip_michael,
  date = win_dates,
  KEEP.OUT.ATTRS = FALSE, stringsAsFactors = FALSE
))
cal_michael[, date := as.Date(date)]
cal_michael[, rel_day := as.integer(date - as.Date(example_date0))]
cal_michael[, rel_day_f := factor(as.character(rel_day),
                                  levels = as.character(min_lag:max_lead))]

# Reduce to a readable number of ZIP rows (ordered north→south)
max_rows <- 60L
cent <- st_coordinates(st_centroid(zctas_fl_m)) %>% as.data.frame()
cent$zip <- zctas_fl_m$zip
zorder <- cal_michael %>%
  distinct(zip) %>%
  left_join(cent, by = "zip") %>%
  arrange(desc(Y)) %>%
  mutate(zip_lab = factor(zip, levels = zip))
if (length(unique(zorder$zip)) > max_rows) {
  keep_zip     <- zorder$zip[1:max_rows]
  cal_michael  <- cal_michael[zip %in% keep_zip]
  zorder       <- zorder %>% filter(zip %in% keep_zip)
}
cal_michael <- cal_michael %>%
  left_join(zorder %>% select(zip, zip_lab), by = "zip")

# Palette for Panel C
blue_vec <- colorRampPalette(brewer.pal(9, "Blues"))(8)  # -8..-1 (light->dark)
names(blue_vec) <- as.character(min_lag:-1)
zero_col <- c("0" = "#000000")                           # 0 = black
red_seq  <- colorRampPalette(brewer.pal(9, "Reds"))(8)   # +1..+8 base
red_vec  <- rev(red_seq)                                 # dark->light
names(red_vec) <- as.character(1:max_lead)
fill_vals <- c(blue_vec, zero_col, red_vec)

pC <- ggplot(cal_michael) +
  geom_tile(
    aes(x = date, y = zip_lab, fill = rel_day_f),
    color = "white", linewidth = 0.1        # keep borders in the plot
  ) +
  scale_fill_manual(
    values = fill_vals, drop = FALSE,
    name = "Relative day",
    guide = guide_legend(
      nrow = 1,
      keyheight = unit(3, "mm"),
      keywidth  = unit(4, "mm"),
      title.position = "top",
      label.position = "bottom",
      # --- Key change: remove borders on legend keys only ---
      override.aes = list(colour = NA, linewidth = 0)
    )
  ) +
  scale_x_date(date_breaks = "2 day", date_labels = "%b %d", expand = c(0.01, 0.01)) +
  labs(
    title = "C. ZIP × day exposure calendar",
    x = NULL, y = "ZIP"
  ) +
  theme(
    plot.title      = element_text(face = "bold"),
    axis.text.y     = element_text(size = 5),
    axis.text.x     = element_text(angle = 45, hjust = 1),
    panel.grid      = element_blank(),
    legend.position = "bottom",
    legend.title    = element_text(size = 7),
    legend.text     = element_text(size = 6),

    # no inner padding of the legend box:
    legend.margin   = margin(0, 0, 0, 0),

    # spacing between keys:
    legend.spacing.x  = unit(0, "pt"),
    legend.spacing.y  = unit(0, "pt"),

    # optional: ensure the legend key itself has no stroke/border
    legend.key        = element_rect(colour = NA, fill = NA),

    # key (swatch) size — keep reasonable so labels fit
    legend.key.width  = unit(4, "mm"),
    legend.key.height = unit(3, "mm")
  )

library(patchwork)

# Design grid (2 rows × 2 columns):
# Row 1: A  C
# Row 2: B  C   -> C spans vertically across both rows in the right column
design <- "
AB
CC
"
fig1 <- pA + pB + pC +
  plot_layout(design = design, heights = c(1, 1.2))

print(fig1)

ggsave("figs/Figure1_constructing_exposure_event_time.png", fig1, width = 8.5, height = 6, dpi = 600)
#ggsave("figs/Figure1_constructing_exposure_event_time.pdf",  fig1, width = 16, height = 12)
```

## Figure 2

Read in model results
```{r}
m_event_34kt <- readRDS("m_event_34kt.rds")
#m_event_34kt_placebo <- readRDS("m_event_34kt_placebo.rds")
m_event_55kt <- readRDS("m_event_55kt.rds")
#m_event_55kt_placebo <- readRDS("m_event_55kt_placebo.rds")
m_event_64kt <- readRDS("m_event_64kt.rds")
m_event_64kt_placebo <- readRDS("m_event_64kt_placebo.rds")
```

```{r}
library(ggplot2)
library(broom)
library(dplyr)
library(stringr)
library(scales)
library(patchwork)

theme_pub <- function(base_size = 10) {
  theme_minimal(base_size = base_size) +
    theme(
      panel.grid.major.x = element_blank(),
      panel.grid.minor   = element_blank(),
      panel.grid.major.y = element_line(color = "grey85", linewidth = 0.4),
      panel.border       = element_rect(color = "black", fill = NA, linewidth = 0.5),
      axis.title         = element_text(color = "black"),
      axis.text          = element_text(color = "black"),
      axis.ticks         = element_line(color = "black"),
      plot.title         = element_text(face = "bold", hjust = 0),
      plot.subtitle      = element_text(hjust = 0),
      legend.position    = "none",
      plot.margin        = margin(6, 8, 6, 6)
    )
}

# ---- Panel A: Event-study profile ----
plot_rr_event <- function(model,
                          prefix = "rel_day_f::",
                          highlight_day = 0,
                          ci = c("ribbon", "errorbar"),
                          log_y = FALSE,
                          title = "Rate ratio by day relative to impact",
                          subtitle = NULL,
                          caption = "Points show RR; shading/lines show 95% CI.",
                          base_size = 10) {

  ci <- match.arg(ci)

  rr_df <- tidy(model, conf.int = TRUE) %>%
    dplyr::filter(startsWith(term, prefix)) %>%
    mutate(
      rel_day = as.integer(sub(prefix, "", term)),
      RR  = exp(estimate),
      LCI = exp(conf.low),
      UCI = exp(conf.high)
    ) %>%
    arrange(rel_day)

  x_breaks <- sort(unique(rr_df$rel_day))

  if (log_y) {
    y_scale <- scale_y_log10(
      breaks = pretty_breaks(n = 6),
      labels = number_format(accuracy = 0.01),
      expand = expansion(mult = c(0.02, 0.06)),
      name = "Rate ratio (RR, log scale)"
    )
  } else {
    y_min <- min(rr_df$LCI, na.rm = TRUE)
    y_max <- max(rr_df$UCI, na.rm = TRUE)
    pad   <- 0.05 * (y_max - y_min)
    y_scale <- scale_y_continuous(
      limits = c(max(0, y_min - pad), y_max + pad),
      breaks = pretty_breaks(n = 6),
      labels = number_format(accuracy = 0.01),
      expand = expansion(mult = c(0.02, 0.06)),
      name = "Rate ratio (RR)"
    )
  }

  p <- ggplot(rr_df, aes(x = rel_day, y = RR)) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "grey35", linewidth = 0.5)

  if (!is.null(highlight_day) && highlight_day %in% rr_df$rel_day) {
    p <- p + annotate(
      "rect",
      xmin = highlight_day - 0.45, xmax = highlight_day + 0.45,
      ymin = -Inf, ymax = Inf,
      fill = "grey92", alpha = 0.6
    )
  }

  if (ci == "ribbon") {
    p <- p + geom_ribbon(
      aes(ymin = LCI, ymax = UCI),
      fill = "grey75", alpha = 0.5
    )
  } else {
    p <- p + geom_errorbar(
      aes(ymin = LCI, ymax = UCI),
      width = 0.2, color = "grey30", linewidth = 0.5
    )
  }

  p +
    geom_line(color = "black", linewidth = 0.9) +
    geom_point(color = "black", size = 2) +
    scale_x_continuous(breaks = x_breaks, name = "Days relative to impact") +
    y_scale +
    labs(
      title = title,
      subtitle = subtitle,
      caption = caption
    ) +
    theme_pub(base_size = base_size)
}

# ---- Helpers for Panel B ----
avg_lags <- function(m, days, prefix = "rel_day_f::", include_missing_as_zero = TRUE){
  beta <- coef(m)
  V    <- vcov(m)

  wanted_terms <- paste0(prefix, days)
  present <- wanted_terms[wanted_terms %in% names(beta)]
  missing <- setdiff(wanted_terms, present)

  if(length(present) == 0){
    stop("None of the requested terms are in the model. Check coef(m) names and your prefix/days.")
  }

  denom <- if(include_missing_as_zero) length(wanted_terms) else length(present)
  w_present <- rep(1/denom, length(present))

  est <- sum(w_present * beta[present])

  Vpp <- V[present, present, drop = FALSE]
  var <- as.numeric(t(w_present) %*% Vpp %*% w_present)
  se  <- sqrt(var)

  lo <- est - 1.96 * se
  hi <- est + 1.96 * se

  out <- data.frame(
    days_min = min(days),
    days_max = max(days),
    n_days_requested = length(days),
    n_terms_present = length(present),
    n_terms_missing = length(missing),
    include_missing_as_zero = include_missing_as_zero,
    logRR = est,
    SE = se,
    logRR_L = lo,
    logRR_U = hi,
    RR = exp(est),
    RR_L = exp(lo),
    RR_U = exp(hi)
  )
  attr(out, "present_terms") <- present
  attr(out, "missing_terms") <- missing
  out
}

summarize_prepost <- function(model, model_label,
                              pre_days, post_days,
                              prefix = "rel_day_f::",
                              include_missing_as_zero = TRUE) {
  pre  <- avg_lags(model, pre_days,  prefix = prefix, include_missing_as_zero = include_missing_as_zero) |>
    mutate(period = "Pre",  model = model_label)
  post <- avg_lags(model, post_days, prefix = prefix, include_missing_as_zero = include_missing_as_zero) |>
    mutate(period = "Post", model = model_label)
  bind_rows(pre, post) |>
    mutate(period = factor(period, levels = c("Pre", "Post")))
}

extract_days <- function(m, period_label, days, prefix = "rel_day_f::") {
  beta <- coef(m)
  tibble(
    day   = days,
    term  = paste0(prefix, day),
    logRR = unname(beta[term]),
    RR    = exp(logRR),
    period = factor(period_label, levels = c("Pre", "Post"))
  )
}

# ---- Panel B: Pre/Post plot ----
plot_prepost_rr <- function(res_days, res_main,
                            log_y = FALSE,
                            show_title = TRUE,
                            seed = 2026) {
  set.seed(seed)

  if (!log_y) {
    y_min <- min(res_main$RR_L, res_days$RR, na.rm = TRUE)
    y_max <- max(res_main$RR_U, res_days$RR, na.rm = TRUE)
    pad   <- 0.05 * (y_max - y_min)
  }

  p <- ggplot() +
    geom_hline(yintercept = 1, linetype = "dashed", color = "grey35", linewidth = 0.5) +
    geom_point(
      data = res_days |> filter(period == "Pre"),
      aes(x = period, y = RR, alpha = alpha),
      position = position_jitter(width = 0.12, height = 0),
      size = 1.8, color = "grey10", show.legend = FALSE
    ) +
    geom_point(
      data = res_days |> filter(period == "Post"),
      aes(x = period, y = RR, alpha = alpha),
      position = position_jitter(width = 0.12, height = 0),
      size = 1.8, color = "grey10", show.legend = FALSE
    ) +
    geom_errorbar(
      data = res_main,
      aes(x = period, ymin = RR_L, ymax = RR_U),
      width = 0.12, linewidth = 0.9, color = "black"
    ) +
    geom_point(
      data = res_main,
      aes(x = period, y = RR),
      size = 3, color = "black"
    ) +
    scale_x_discrete(drop = FALSE, name = "Window")

  if (log_y) {
    p <- p + scale_y_log10(
      name = "Rate ratio (RR, log scale)",
      breaks = c(0.8, 1, 1.25, 1.5, 2),
      minor_breaks = NULL
    )
  } else {
    p <- p + scale_y_continuous(
      name = "Rate ratio (RR)",
      limits = c(max(0, y_min - pad), y_max + pad)
    )
  }

  if (show_title) {
    p <- p + labs(
      title = "Average pre/post rate ratio (with daily coefficients)",
      subtitle = "Daily dots jittered; darker = closer to impact day (−1 for Pre, +1 for Post)"
    )
  }

  p + theme_pub(10)
}

# ---- Build data for Panel B ----
pre_days  <- -8:-1
post_days <-  1:8
coef_prefix <- "rel_day_f::"

res_main <- summarize_prepost(m_event_64kt, "Main (33 m/s)", pre_days, post_days)

res_days <- bind_rows(
  extract_days(m_event_64kt, "Pre",  pre_days,  prefix = coef_prefix),
  extract_days(m_event_64kt, "Post", post_days, prefix = coef_prefix)
)

alpha_min  <- 0.4
alpha_range <- 1 - alpha_min

res_days <- res_days |>
  mutate(
    alpha = case_when(
      period == "Pre"  ~ alpha_min + alpha_range * (1 - (abs(day) - 1) / (max(abs(pre_days)) - 1)),
      period == "Post" ~ alpha_min + alpha_range * (1 - (day - 1) / (max(post_days) - 1)),
      TRUE ~ 1
    )
  )

# ---- Create the two panels ----
panel_A <- plot_rr_event(m_event_64kt, ci = "ribbon", log_y = FALSE,
                         title = "A. Event profile across days",
                         subtitle = NULL, caption = NULL)

panel_B <- plot_prepost_rr(res_days, res_main, log_y = FALSE, show_title = FALSE) +
  labs(title = "B. Average pre/post rate ratio")

Fig2 <- panel_A / panel_B + plot_layout(heights = c(1, 1)) &
  theme_pub(10)

ggsave("figs/Figure2_profile_pre_post_rr.png", Fig2, width = 4, height = 5, units = "in", dpi = 600)
```

## Figure 3

```{r}
library(fixest)
library(dplyr)
library(ggplot2)
library(scales)

avg_lags <- function(m, days, prefix = "rel_day_f::", include_missing_as_zero = TRUE){
  beta <- coef(m)
  V    <- vcov(m)

  wanted_terms <- paste0(prefix, days)
  present <- wanted_terms[wanted_terms %in% names(beta)]

  if(length(present) == 0){
    stop("None of the requested terms are in the model. Check coef(m) names and your prefix/days.")
  }

  # weights for the average
  denom <- if(include_missing_as_zero) length(wanted_terms) else length(present)
  w_present <- rep(1/denom, length(present))

  # estimate (log scale)
  est <- sum(w_present * beta[present])

  # variance: w' V w (only over present coefficients)
  Vpp <- V[present, present, drop = FALSE]
  var <- as.numeric(t(w_present) %*% Vpp %*% w_present)
  se  <- sqrt(var)

  # 95% CI on log scale
  lo <- est - 1.96 * se
  hi <- est + 1.96 * se

  out <- data.frame(
    days_min = min(days),
    days_max = max(days),
    n_days_requested = length(days),
    n_terms_present = length(present),
    n_terms_missing = length(setdiff(wanted_terms, present)),
    include_missing_as_zero = include_missing_as_zero,
    logRR = est,
    SE = se,
    logRR_L = lo,
    logRR_U = hi,
    RR = exp(est),
    RR_L = exp(lo),
    RR_U = exp(hi)
  )

  attr(out, "present_terms") <- present
  out
}

# --- Helper: summarize PRE-only for one model ---
summarize_pre_only <- function(model, label,
                               pre_days,
                               prefix = "rel_day_f::",
                               include_missing_as_zero = TRUE) {
  avg_lags(model, pre_days,
           prefix = prefix,
           include_missing_as_zero = include_missing_as_zero) |>
    mutate(group = label)
}

# Define the pre-impact window (adjust as needed)
pre_days <- -8:-1
coef_prefix <- "rel_day_f::"

# Compute pre-impact averages for 34kt, 55kt, 64kt 
res_pre <- bind_rows(
  summarize_pre_only(m_event_34kt, "≥ 17 m/s", pre_days),
  summarize_pre_only(m_event_55kt, "≥ 28 m/s", pre_days),
  summarize_pre_only(m_event_64kt, "≥ 33 m/s", pre_days)
) |>
  # Ensure left-to-right order: 34 -> 55 -> 64
  mutate(group = factor(group, levels = c("≥ 17 m/s", "≥ 28 m/s", "≥ 33 m/s")))

extract_day_estimates <- function(m, label, days, prefix = "rel_day_f::") {
  beta <- coef(m)
  tibble(
    day = days,
    term = paste0(prefix, day),
    logRR = unname(beta[term]),
    RR = exp(logRR)
  ) |>
    mutate(group = label)
}

res_days <- bind_rows(
  extract_day_estimates(m_event_34kt, "≥ 17 m/s", pre_days, prefix = coef_prefix),
  extract_day_estimates(m_event_55kt, "≥ 28 m/s", pre_days, prefix = coef_prefix),
  extract_day_estimates(m_event_64kt, "≥ 33 m/s", pre_days, prefix = coef_prefix)
) |>
  mutate(
    group = factor(group, levels = c("≥ 17 m/s", "≥ 28 m/s", "≥ 33 m/s")),
    # Map day to a 0..1 scale so -8 is light, -1 is dark
    day_rank = (day - min(pre_days)) / (max(pre_days) - min(pre_days))
  )

res_pre <- res_pre |>
  mutate(group = factor(group, levels = c("≥ 17 m/s", "≥ 28 m/s", "≥ 33 m/s")))

res_days <- res_days |>
  mutate(group = factor(group, levels = c("≥ 17 m/s", "≥ 28 m/s", "≥ 33 m/s")))

set.seed(2026)

p <- ggplot() +
  geom_hline(yintercept = 1, linetype = "dashed", color = "grey40", linewidth = 0.5) +

  geom_point(
    data = res_days,
    aes(x = group, y = RR, color = day),
    position = position_jitter(width = 0.12, height = 0),
    size = 2,
    alpha = 0.6,
    show.legend = FALSE
  ) +

  geom_errorbar(
    data = res_pre,
    aes(x = group, ymin = RR_L, ymax = RR_U),
    width = 0.12,
    linewidth = 0.9,
    color = "black"
  ) +
  geom_point(
    data = res_pre,
    aes(x = group, y = RR),
    size = 3.3,
    color = "black"
  ) +

  # Monochrome gradient for -8 (light) to -1 (dark)
  scale_color_gradient(low = "grey75", high = "grey15") +

  scale_y_continuous(
    breaks = pretty_breaks(n = 5),
    labels = label_number(accuracy = 0.01)
  ) +

  labs(
    x = "Wind speed exceedance",
    y = "Pre-impact average RR (95% CI)",
    title = "Pre-impact average rate ratios by wind speed threshold",
    subtitle = "Dots: coefficients for days −8 to −1 (darker: closer to impact day)"
  ) +

  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 13.5, margin = margin(b = 6)),
    plot.subtitle = element_text(size = 11, color = "grey20", margin = margin(b = 8)),
    axis.title.x = element_text(size = 12, margin = margin(t = 8)),
    axis.title.y = element_text(size = 12, margin = margin(r = 8)),
    axis.text = element_text(size = 11, color = "black"),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

Fig3 <- p
print(Fig3)

ggsave("figs/Figure3_preimpact_rr_by_threshold.png", Fig3, width = 6, height = 4, units = "in", dpi = 600)
# ggsave("preimpact_rr_by_threshold.pdf", Fig3, width = 6.0, height = 4.0, units = "in")
```

## Figure S1
```{r}
library(fixest)
library(dplyr)
library(ggplot2)
library(scales)

# ---- Averaging function (unchanged) ----
avg_lags <- function(m, days, prefix = "rel_day_f::", include_missing_as_zero = TRUE){
  beta <- coef(m)
  V    <- vcov(m)

  wanted_terms <- paste0(prefix, days)
  present <- wanted_terms[wanted_terms %in% names(beta)]
  missing <- setdiff(wanted_terms, present)

  if(length(present) == 0){
    stop("None of the requested terms are in the model. Check coef(m) names and your prefix/days.")
  }

  # weights for the average
  denom <- if(include_missing_as_zero) length(wanted_terms) else length(present)
  w_present <- rep(1/denom, length(present))

  # estimate (log scale)
  est <- sum(w_present * beta[present])

  # variance: w' V w (only over present coefficients)
  Vpp <- V[present, present, drop = FALSE]
  var <- as.numeric(t(w_present) %*% Vpp %*% w_present)
  se  <- sqrt(var)

  # 95% CI on log scale
  lo <- est - 1.96 * se
  hi <- est + 1.96 * se

  out <- data.frame(
    days_min = min(days),
    days_max = max(days),
    n_days_requested = length(days),
    n_terms_present = length(present),
    n_terms_missing = length(missing),
    include_missing_as_zero = include_missing_as_zero,
    logRR = est,
    SE = se,
    logRR_L = lo,
    logRR_U = hi,
    RR = exp(est),
    RR_L = exp(lo),
    RR_U = exp(hi)
  )

  attr(out, "present_terms") <- present
  attr(out, "missing_terms") <- missing
  out
}

# ---- Helpers (pre-only) ----
summarize_pre_only <- function(model, label,
                               pre_days,
                               prefix = "rel_day_f::",
                               include_missing_as_zero = TRUE) {
  avg_lags(model, pre_days,
           prefix = prefix,
           include_missing_as_zero = include_missing_as_zero) |>
    mutate(model = label, period = "Pre")
}

extract_pre_days <- function(model, label, pre_days, prefix = "rel_day_f::") {
  beta <- coef(model)
  tibble(
    model = label,
    day   = pre_days,
    term  = paste0(prefix, day),
    logRR = unname(beta[term]),
    RR    = exp(logRR)
  )
}

# ---- Plot function: Main vs Placebo for PRE only (single panel) ----
plot_pre_placebo_comparison <- function(main_model, placebo_model, main_label,
                                        pre_days = -8:-1,
                                        prefix   = "rel_day_f::",
                                        title    = NULL,
                                        use_log_y = FALSE,
                                        y_limits = NULL) {

  # Pre-window averages
  res_avg <- dplyr::bind_rows(
    summarize_pre_only(main_model,    paste0(main_label, " (Main)"),    pre_days, prefix = prefix),
    summarize_pre_only(placebo_model, "Placebo",                         pre_days, prefix = prefix)
  ) |>
    dplyr::mutate(model = factor(model, levels = c(paste0(main_label, " (Main)"), "Placebo")))

  # Per-day coefficients (assumes terms present or NA if absent)
  res_days <- dplyr::bind_rows(
    extract_pre_days(main_model,    paste0(main_label, " (Main)"), pre_days, prefix = prefix),
    extract_pre_days(placebo_model, "Placebo",                      pre_days, prefix = prefix)
  ) |>
    dplyr::mutate(model = factor(model, levels = levels(res_avg$model)))

  main_level <- paste0(main_label, " (Main)")

  set.seed(2026)  # reproducible jitter

  p <- ggplot2::ggplot() +
    ggplot2::geom_hline(yintercept = 1, linetype = "dashed", color = "grey40", linewidth = 0.5) +

    # Daily dots — Main: filled, darker towards -1
    ggplot2::geom_point(
      data = dplyr::filter(res_days, model == main_level),
      ggplot2::aes(x = model, y = RR, color = day),
      position = ggplot2::position_jitter(width = 0.10, height = 0),
      size = 2.2, shape = 16, alpha = 0.9, show.legend = FALSE
    ) +

    # Daily dots — Placebo: open, slightly lighter
    ggplot2::geom_point(
      data = dplyr::filter(res_days, model == "Placebo"),
      ggplot2::aes(x = model, y = RR, color = day),
      position = ggplot2::position_jitter(width = 0.10, height = 0),
      size = 2.2, shape = 1, alpha = 0.55, show.legend = FALSE
    ) +

    # Pre-average ±95% CI (on top)
    ggplot2::geom_errorbar(
      data = res_avg,
      ggplot2::aes(x = model, ymin = RR_L, ymax = RR_U),
      width = 0.12, linewidth = 0.9, color = "black"
    ) +
    ggplot2::geom_point(
      data = res_avg,
      ggplot2::aes(x = model, y = RR),
      size = 3.3, color = "black"
    ) +

    # Greyscale: -8 (light) -> -1 (dark)
    ggplot2::scale_color_gradient(low = "grey75", high = "grey15") +

    ggplot2::labs(
      x = NULL,
      y = "Pre-storm average RR (95% CI)",
      title = if (is.null(title)) paste0("Pre-storm daily RRs and average: ", main_label) else title,
      subtitle = "Dots: coefficients for days −8 to −1 (darker: closer to impact day)"
    ) +

    # Publication-friendly theme
    ggplot2::theme_classic(base_size = 12) +
    ggplot2::theme(
      plot.title = element_text(face = "bold", size = 13.5, margin = margin(b = 6)),
      plot.subtitle = element_text(size = 11, color = "grey20", margin = margin(b = 8)),
      axis.title.y = element_text(size = 12, margin = margin(r = 8)),
      axis.text = element_text(size = 11, color = "black"),
      axis.line = element_line(color = "black"),
      axis.ticks = element_line(color = "black")
    )

  # Log or linear scale
  if (use_log_y) {
    p <- p + ggplot2::scale_y_log10()
  }

  if (!is.null(y_limits)) {
    p <- p + ggplot2::coord_cartesian(ylim = y_limits)
  }

  list(plot = p, res_avg = res_avg, res_days = res_days)
}

# ---- Define pre window ----
pre_days <- -8:-1

# ---- Build just the ≥64 kt figure ----
out_64 <- plot_pre_placebo_comparison(
  main_model    = m_event_64kt,
  placebo_model = m_event_64kt_placebo,
  main_label    = "≥ 33 m/s",
  pre_days      = pre_days,
  use_log_y     = FALSE  # set TRUE if you prefer log scale
)

FigS1 <- out_64$plot
print(FigS1)

# ---- Optional: save a high-resolution export ----
ggsave("figs/FigureS1_placebo_pre_rr_64kt.png", FigS1, width = 5.5, height = 4.0, units = "in", dpi = 600)
# ggsave("placebo_pre_rr_64kt.pdf", FigS1, width = 5.5, height = 4.0, units = "in")
```

## Figure S2

```{r}
res <- readRDS("placebo_RR.rds")

library(ggplot2)

# Convert placebo RRs to data frame
df_placebo <- data.frame(rr = res$placebo_rr)

FigS2 <- ggplot(df_placebo, aes(x = rr)) +
  geom_histogram(
    bins = 20,
    color = "black",
    fill = "grey75"
  ) +
  geom_vline(
    xintercept = res$observed_rr,
    color = "grey35",
    linewidth = 1.1
  ) +
  labs(
    title = "Spatial Permutation Falsification",
    subtitle = paste0(
      "Observed pre-impact RR = ",
      round(res$observed_rr, 3),
      " (empirical p = ",
      signif(res$empirical_p, 2),
      ")"
    ),
    x = "Placebo Pre-Impact Window RR (−8…−1)",
    y = "Frequency"
  ) +
  theme_minimal(base_size = 12)

print(FigS2)

ggsave(
  "figs/FigureS2_Spatial_Permutation_Placebo.png",
  FigS2,
  width = 6,
  height = 4.5,
  dpi = 300
)
```


